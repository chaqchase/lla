name: Release Packages

on:
    repository_dispatch:
        types:
            - release-packages
    workflow_dispatch:
        inputs:
            release_tag:
                description: Release tag to target (e.g. v1.2.3)
                required: false
            release_version:
                description: Release version without the v prefix
                required: false

jobs:
    guard:
        name: Resolve Release Context
        runs-on: ubuntu-latest
        permissions:
            contents: read
        outputs:
            release_tag: ${{ steps.resolve.outputs.release_tag }}
            release_version: ${{ steps.resolve.outputs.release_version }}
        steps:
            - uses: actions/checkout@v4

            - name: Resolve release metadata
              id: resolve
              env:
                  INPUT_TAG: ${{ inputs.release_tag }}
                  INPUT_VERSION: ${{ inputs.release_version }}
                  PAYLOAD_TAG: ${{ github.event.client_payload.tag }}
                  PAYLOAD_VERSION: ${{ github.event.client_payload.version }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail

                  tag="${PAYLOAD_TAG:-}"
                  if [[ -z "$tag" ]]; then
                    tag="${INPUT_TAG:-}"
                  fi
                  if [[ -z "$tag" ]]; then
                    echo "::error::release_tag input is required when dispatch payload is absent"
                    exit 1
                  fi

                  version="${PAYLOAD_VERSION:-}"
                  if [[ -z "$version" ]]; then
                    version="${INPUT_VERSION:-}"
                  fi
                  if [[ -z "$version" ]]; then
                    version="${tag#v}"
                  fi

                  gh release view "$tag" >/dev/null

                  echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
                  echo "release_version=$version" >> "$GITHUB_OUTPUT"

    nfpm_packages:
        name: Generate OS Packages
        needs: guard
        runs-on: ubuntu-latest
        permissions:
            contents: write
        env:
            RELEASE_TAG: ${{ needs.guard.outputs.release_tag }}
            RELEASE_VERSION: ${{ needs.guard.outputs.release_version }}
        steps:
            - uses: actions/checkout@v4

            - name: Prepare helper scripts
              run: chmod +x .github/scripts/release_helpers.sh

            - name: Check package assets
              id: package_guard
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  source .github/scripts/release_helpers.sh

                  declare -a assets=(
                    "lla_${RELEASE_VERSION}_amd64.deb"
                    "lla-${RELEASE_VERSION}-1.x86_64.rpm"
                    "lla-${RELEASE_VERSION}-r0.x86_64.apk"
                    "lla-${RELEASE_VERSION}-1-x86_64.pkg.tar.zst"
                    "lla_${RELEASE_VERSION}_arm64.deb"
                    "lla-${RELEASE_VERSION}-1.aarch64.rpm"
                    "lla-${RELEASE_VERSION}-r0.aarch64.apk"
                    "lla-${RELEASE_VERSION}-1-aarch64.pkg.tar.zst"
                    "lla_${RELEASE_VERSION}_i386.deb"
                    "lla-${RELEASE_VERSION}-1.i686.rpm"
                    "lla-${RELEASE_VERSION}-r0.x86.apk"
                    "lla-${RELEASE_VERSION}-1-i686.pkg.tar.zst"
                  )

                  missing_count=0
                  for asset in "${assets[@]}"; do
                    if ! asset_exists "$RELEASE_TAG" "$asset"; then
                      echo "missing asset: $asset"
                      missing_count=$((missing_count + 1))
                    fi
                  done

                  if [[ $missing_count -eq 0 ]]; then
                    echo "skip=true" >> "$GITHUB_OUTPUT"
                    log_note "All package assets already exist for $RELEASE_TAG"
                  else
                    log_note "$missing_count package assets missing; packaging will proceed"
                  fi

            - name: Install nFPM
              if: steps.package_guard.outputs.skip != 'true'
              run: |
                  echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
                  sudo apt update
                  sudo apt install -y nfpm gettext-base
                  nfpm --version

            - name: Download Linux binaries from release
              if: steps.package_guard.outputs.skip != 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  mkdir -p core_binaries
                  gh release download "$RELEASE_TAG" -p "lla-linux-*" --dir core_binaries --clobber

            - name: Generate packages
              if: steps.package_guard.outputs.skip != 'true'
              run: |
                  set -euo pipefail
                  mkdir -p packages

                  for binary in core_binaries/lla-linux-*; do
                    [ -f "$binary" ] || continue
                    artifact_name=$(basename "$binary")

                    case "$artifact_name" in
                      *amd64)
                        ARCH="amd64"
                        DEB_ARCH="amd64"
                        RPM_ARCH="x86_64"
                        APK_ARCH="x86_64"
                        PACMAN_ARCH="x86_64"
                        ;;
                      *arm64)
                        ARCH="arm64"
                        DEB_ARCH="arm64"
                        RPM_ARCH="aarch64"
                        APK_ARCH="aarch64"
                        PACMAN_ARCH="aarch64"
                        ;;
                      *i686)
                        ARCH="386"
                        DEB_ARCH="i386"
                        RPM_ARCH="i686"
                        APK_ARCH="x86"
                        PACMAN_ARCH="i686"
                        ;;
                      *)
                        echo "Skipping unsupported artifact $artifact_name"
                        continue
                        ;;
                    esac

                    export VERSION="$RELEASE_VERSION"
                    export ARCH
                    export BINARY_PATH="$binary"

                    tmp_config=$(mktemp)
                    envsubst < nfpm.yaml > "$tmp_config"

                    nfpm pkg --config "$tmp_config" --packager deb --target "packages/lla_${VERSION}_${DEB_ARCH}.deb"
                    nfpm pkg --config "$tmp_config" --packager rpm --target "packages/lla-${VERSION}-1.${RPM_ARCH}.rpm"
                    nfpm pkg --config "$tmp_config" --packager apk --target "packages/lla-${VERSION}-r0.${APK_ARCH}.apk"
                    nfpm pkg --config "$tmp_config" --packager archlinux --target "packages/lla-${VERSION}-1-${PACMAN_ARCH}.pkg.tar.zst"

                    rm -f "$tmp_config"
                  done

            - name: Upload packages to release
              if: steps.package_guard.outputs.skip != 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  source .github/scripts/release_helpers.sh
                  shopt -s nullglob
                  for pkg in packages/*; do
                    filename=$(basename "$pkg")
                    if asset_exists "$RELEASE_TAG" "$filename"; then
                      log_note "Skipping existing package $filename"
                      continue
                    fi
                    gh release upload "$RELEASE_TAG" "$pkg"
                  done

            - name: Dispatch themes workflow
              if: ${{ success() }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  source .github/scripts/release_helpers.sh
                  dispatch_next_stage "release-themes" "$RELEASE_TAG" "$RELEASE_VERSION"
