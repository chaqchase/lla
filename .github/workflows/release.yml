name: Release Core Bins

on:
  pull_request_target:
    types: [closed]
    branches: [main]
  workflow_dispatch:

jobs:
  check_release:
    name: Determine Release Status
    if: |
      (github.event_name == 'workflow_dispatch' && github.actor == 'chaqchase') ||
      (github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      should_release: ${{ steps.check_version.outputs.should_release }}
      current_version: ${{ steps.check_version.outputs.current_version }}
      release_tag: ${{ steps.check_version.outputs.release_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version changes
        id: check_version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          OLD_VERSION=$(gh release view --json tagName --jq '.tagName' | sed 's/^v//' || echo "0.0.0")
          CURRENT_VERSION=$(sed -n '/^\[workspace\.package\]/,/^\[/p' Cargo.toml | grep '^version = ' | cut -d '"' -f 2)

          echo "Old version: $OLD_VERSION"
          echo "Current version: $CURRENT_VERSION"

          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "release_tag=v$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

          if [ "$OLD_VERSION" != "$CURRENT_VERSION" ]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          fi

  build_core:
    needs: check_release
    if: needs.check_release.outputs.should_release == 'true'
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: lla-linux-amd64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: lla-linux-arm64
            cross_compile: true
          - os: ubuntu-latest
            target: i686-unknown-linux-gnu
            artifact_name: lla-linux-i686
            cross_compile: true
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: lla-macos-amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: lla-macos-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: ${{ matrix.target }}

      - name: Ensure stable toolchain and target installed
        run: |
          rustup override set stable
          rustup show active-toolchain
          rustup target add ${{ matrix.target }} --toolchain stable
          rustup target list --installed

      - name: Verify target std presence
        run: |
          rustup component add rust-std --toolchain stable --target ${{ matrix.target }}
          rustc +stable --print target-libdir --target ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.cross_compile && runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu gcc-i686-linux-gnu
          sudo apt-get install -y crossbuild-essential-arm64 crossbuild-essential-i386

      - name: Set cross-compilation environment
        if: matrix.cross_compile && runner.os == 'Linux'
        run: |
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CARGO_TARGET_I686_UNKNOWN_LINUX_GNU_LINKER=i686-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build release
        env:
          RUSTUP_TOOLCHAIN: stable
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare binary
        run: |
          cp target/${{ matrix.target }}/release/lla ${{ matrix.artifact_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

  publish_crates:
    needs: check_release
    if: needs.check_release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Update dependency version
        run: |
          VERSION="${{ needs.check_release.outputs.current_version }}"
          sed -i 's/version = "[0-9]*\.[0-9]*\.[0-9]*"/version = "'$VERSION'"/' lla/Cargo.toml

      - name: Check and publish to crates.io
        env:
          CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          set -euo pipefail
          cargo login ${{ secrets.CRATES_IO_TOKEN }}

          VERSION="${{ needs.check_release.outputs.current_version }}"

          publish_crate_if_needed() {
            local crate_name="$1"
            local sleep_after="${2:-false}"
            local published
            published=$(cargo search "$crate_name" --limit 1 | awk -F '"' '{print $2}')
            if [ "$published" != "$VERSION" ]; then
              echo "Publishing $crate_name v$VERSION"
              cargo publish -p "$crate_name"
              if [ "$sleep_after" = "true" ]; then
                sleep 30
              fi
            else
              echo "$crate_name v$VERSION already published, skipping"
            fi
          }

          publish_crate_if_needed "lla_plugin_interface" true
          publish_crate_if_needed "lla_plugin_utils" true
          publish_crate_if_needed "lla"

  release_core:
    needs: [check_release, build_core, publish_crates]
    if: needs.check_release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      RELEASE_VERSION: ${{ needs.check_release.outputs.current_version }}
      RELEASE_TAG: ${{ needs.check_release.outputs.release_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Prepare helper scripts
        run: chmod +x .github/scripts/release_helpers.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Build SHA256 sums file
        run: |
          set -euo pipefail
          find artifacts -type f -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS

      - name: Create release notes
        run: |
          {
            echo "# Release ${RELEASE_TAG}"
            echo
            if [ -f CHANGELOG.md ]; then
              echo "## Changelog"
              echo
              sed -n "/## \[${RELEASE_VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' || true
              echo
            fi
            if [ -f SHA256SUMS ]; then
              echo "## SHA256 Checksums"
              echo
              echo '```'
              cat SHA256SUMS
              echo '```'
            fi
          } > RELEASE_NOTES.md

      - name: Ensure GitHub release exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source .github/scripts/release_helpers.sh
          ensure_release_exists "$RELEASE_TAG" "Release ${RELEASE_TAG}" "RELEASE_NOTES.md"

      - name: Upload core binaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          source .github/scripts/release_helpers.sh
          shopt -s nullglob
          for artifact in artifacts/*/*; do
            filename=$(basename "$artifact")
            if asset_exists "$RELEASE_TAG" "$filename"; then
              log_note "Skipping existing asset $filename"
              continue
            fi
            gh release upload "$RELEASE_TAG" "$artifact"
          done

      - name: Upload SHA256 sums
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          source .github/scripts/release_helpers.sh
          if asset_exists "$RELEASE_TAG" "SHA256SUMS"; then
            log_note "SHA256SUMS already present"
            exit 0
          fi
          gh release upload "$RELEASE_TAG" SHA256SUMS

      - name: Dispatch plugin workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source .github/scripts/release_helpers.sh
          dispatch_next_stage "release-plugins" "$RELEASE_TAG" "$RELEASE_VERSION"
